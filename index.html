<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StoreConnect POS Actions 3.0</title>
  <style>
    body { margin: 0; padding: 0; font-family: 'Salesforce Sans', Arial, sans-serif; }
    #status { padding: 12px; margin: 12px; color: #444; background: #f3f3f3; border-radius: 4px; }
    #status.error { color: #b00020; background: #ffebee; }
    #lo2-container { width: 100%; min-height: 500px; }
  </style>

  <!-- âœ… Use Aura Site loader script -->
  <script
    src="https://warranty2amartfurniture--amartuat.sandbox.my.site.com/posactions/lightning/lightning.out.latest/index.iife.prod.js"
    onload="window.LO2_READY = true;"
    onerror="console.error('LO2 script failed to load!')"
    async
  ></script>
</head>
<body>
  <div id="status">Initializing Lightning Out 2.0...</div>
  <div id="lo2-container"></div>

  <script>
    (function () {
      const APP_ID = '1Us9n00000000mPCAQ';
      const COMPONENT = 'c:posActionsHostLWC';
      const RAILWAY_PROXY = 'https://sc-auth-amart-production.up.railway.app';
      const ENV = 'uat';

      const statusEl = document.getElementById('status');
      const container = document.getElementById('lo2-container');

      function setStatus(msg, isError = false) {
        statusEl.textContent = msg;
        statusEl.className = isError ? 'error' : '';
        console.log('[LO2]', msg);
      }

      async function waitForLightningGlobal() {
        while (typeof $Lightning === 'undefined') {
          await new Promise((r) => setTimeout(r, 50));
        }
      }

      async function bootstrapSession(frontdoorUrl) {
        return new Promise((resolve) => {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = frontdoorUrl;
          iframe.onload = () => {
            document.body.removeChild(iframe);
            resolve();
          };
          document.body.appendChild(iframe);
        });
      }

      async function init() {
        try {
          setStatus('Fetching frontdoor URL...');
          const resp = await fetch(`${RAILWAY_PROXY}/api/lo2/frontdoor`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ env: ENV, appId: APP_ID })
          });

          const data = await resp.json();
          if (!resp.ok || !data.frontdoorUrl) throw new Error(data.error || 'No frontdoor URL returned');

          setStatus('Bootstrapping session...');
          await bootstrapSession(data.frontdoorUrl);

          setStatus('Waiting for Lightning runtime...');
          await waitForLightningGlobal();

          setStatus('Initializing Lightning App...');
          $Lightning.use(APP_ID, () => {
            $Lightning.createComponent(COMPONENT, {}, container, (cmp) => {
              console.log('[LO2] Component created', cmp);
              setStatus('Component loaded!');
            });
          }, data.frontdoorUrl);
        } catch (err) {
          console.error('[LO2] ERROR:', err);
          setStatus('Error: ' + err.message, true);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
