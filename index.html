<!DOCTYPE html>
<html>
<head>
  <title>Lightning Out 2.0 - Programmatic (Aura Site)</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #status { margin-bottom: 20px; padding: 10px; border-radius: 4px; background: #f5f5f5; }
    #status.success { background: #e8f5e9; color: #2e7d32; }
    #status.error { background: #ffebee; color: #c62828; }
  </style>

  <!-- Load Lightning Out runtime from the Experience Site (Aura-based) -->
  <script src="https://warranty2amartfurniture--amartuat.sandbox.my.site.com/posactions/lightning/lightning.out.latest.min.js"></script>
</head>
<body>
  <h2>Lightning Out 2.0 - Aura Site (Programmatic)</h2>
  <div id="status">Initializing...</div>
  <div id="container"></div>

  <script>
    const APP_ID = '1Us9n00000000mPCAQ';
    const COMPONENT = 'c:posActionsHostLWC';
    const ENV = 'uat';
    const RAILWAY_PROXY = 'https://sc-auth-amart-production.up.railway.app';
    const statusEl = document.getElementById('status');
    const container = document.getElementById('container');

    function setStatus(msg, type = '') {
      console.log('[LO2]', msg);
      statusEl.textContent = msg;
      statusEl.className = type ? `status ${type}` : 'status';
    }

    async function waitForLightningGlobal() {
      while (typeof $Lightning === 'undefined') {
        await new Promise(r => setTimeout(r, 50));
      }
    }

    async function init() {
      try {
        setStatus('Fetching frontdoor URL...');

        const resp = await fetch(`${RAILWAY_PROXY}/api/lo2/frontdoor`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ env: ENV, appId: APP_ID })
        });

        const { frontdoorUrl, error } = await resp.json();
        if (!resp.ok || !frontdoorUrl) throw new Error(error || 'No frontdoor URL');

        setStatus('Bootstrapping session...');
        await new Promise((resolve) => {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = frontdoorUrl;
          iframe.onload = () => {
            console.log('[LO2] Session iframe loaded');
            document.body.removeChild(iframe);
            resolve();
          };
          document.body.appendChild(iframe);
        });

        setStatus('Waiting for Lightning runtime...');
        await waitForLightningGlobal();

        setStatus('Initializing Lightning App...');
        $Lightning.use(APP_ID, () => {
          $Lightning.createComponent(
            COMPONENT,
            {},
            container,
            cmp => {
              console.log('[LO2] Component loaded', cmp);
              setStatus('Component loaded!', 'success');
            }
          );
        }, frontdoorUrl);

        setStatus('Authenticating via LO2...');
      } catch (err) {
        console.error('[LO2] Error:', err);
        setStatus('Error: ' + err.message, 'error');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
