<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lightning Out 2.0 POC (GitHub Pages)</title>

    <!-- Lightning Out 2.0 library (from your Salesforce org) -->
    <script
      async
      src="https://warranty2amartfurniture--amartuat.sandbox.my.salesforce.com/lightning/lightning.out.latest/index.iife.prod.js"
    ></script>

    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
      .row { margin: 12px 0; }
      button { padding: 10px 14px; cursor: pointer; }
      pre { background: #f6f6f6; padding: 12px; overflow: auto; }
      .ok { color: #0a7; }
      .err { color: #c00; }
      .muted { color: #666; }
      .fieldRow { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      label { font-size: 12px; color: #444; display: block; margin-bottom: 4px; }
      input { padding: 8px 10px; min-width: 260px; }
      .hint { font-size: 12px; color: #666; margin-top: 6px; }
    </style>
  </head>

  <body>
    <h1>Lightning Out 2.0 POC (GitHub Pages)</h1>

    <div class="row fieldRow">
      <div>
        <label for="recordId">recordId (Flow input)</label>
        <input id="recordId" placeholder="e.g. 001..." />
      </div>
      <div>
        <label for="userType">userType (Flow input)</label>
        <input id="userType" placeholder="e.g. Staff / Customer" />
      </div>
      <div>
        <label for="userSfId">userSfId (Flow input)</label>
        <input id="userSfId" placeholder="e.g. 005..." />
      </div>
    </div>

    <div class="row">
      <button id="loginBtn">Login to Salesforce</button>
      <button id="clearBtn" title="Clears pkce verifier + log">Clear Local State</button>
      <span id="status" class="muted"></span>
      <div class="hint">
        Note: Your old Aura component (<code>pos-actions-host</code>) will NOT render in Lightning Out 2.0.
        Use <code>&lt;pos-actions-host-lwc&gt;</code> to run the Flow in LO2.
      </div>
    </div>

    <div class="row">
      <strong>Debug log</strong>
      <pre id="log"></pre>
    </div>

    <!-- Lightning Out 2.0 host (MATCH YOUR GENERATED SNIPPET) -->
    <lightning-out-application
      id="loApp"
      app-id="1Us9n00000000mPCAQ"
      components="pos-actions-host,flow-state-change-event,report-viewer-v2,sosl-flow-search,pos-actions-buttons,pos-actions-host-lwc"
    ></lightning-out-application>

    <!-- Components (MATCH YOUR GENERATED SNIPPET) -->
    <pos-actions-host></pos-actions-host>
    <flow-state-change-event></flow-state-change-event>
    <report-viewer-v2></report-viewer-v2>
    <sosl-flow-search></sosl-flow-search>
    <pos-actions-buttons></pos-actions-buttons>

    <!-- This is your NEW LWC flow host -->
    <pos-actions-host-lwc id="posHost"></pos-actions-host-lwc>

    <script>
      /**********************************************************************
       * CONFIG
       **********************************************************************/
      const SF_BASE = "https://warranty2amartfurniture--amartuat.sandbox.my.salesforce.com";

      // External Client App "Consumer Key" / Client Id
      const CLIENT_ID =
        "3MVG9F.30f8SspDryqeWgfLKZmasLpvzBp6QA1sfqDljMQybgmTuLeXnbaxAkJT5Q66qI3w69nvL0_Nk_eX1c";

      // IMPORTANT: Must EXACTLY match the Callback URL configured in the External Client App.
      const REDIRECT_URI = "https://taljaardjcf.github.io/lwcOutDemo/";

      // POC scopes (you can reduce later)
      const SCOPES = "web full";

      // Your flow API name
      const FLOW_API_NAME = "StoreConnect_POS_Actions";

      /**********************************************************************
       * UI helpers
       **********************************************************************/
      const logEl = document.getElementById("log");
      const statusEl = document.getElementById("status");
      function log(...args) {
        const line = args
          .map((a) => (typeof a === "string" ? a : JSON.stringify(a, null, 2)))
          .join(" ");
        logEl.textContent += line + "\n";
        logEl.scrollTop = logEl.scrollHeight;
        console.log(...args);
      }
      function setStatus(msg, cls) {
        statusEl.className = cls || "muted";
        statusEl.textContent = msg;
      }

      function getInputs() {
        return {
          recordId: document.getElementById("recordId").value || "",
          userType: document.getElementById("userType").value || "",
          userSfId: document.getElementById("userSfId").value || "",
        };
      }

      /**********************************************************************
       * PKCE helpers
       **********************************************************************/
      function base64UrlEncode(arrayBuffer) {
        const bytes = new Uint8Array(arrayBuffer);
        let str = "";
        for (const b of bytes) str += String.fromCharCode(b);
        return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      }

      async function sha256(text) {
        const enc = new TextEncoder().encode(text);
        return await crypto.subtle.digest("SHA-256", enc);
      }

      function randomString(len = 64) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
        const arr = new Uint8Array(len);
        crypto.getRandomValues(arr);
        return Array.from(arr, (x) => chars[x % chars.length]).join("");
      }

      function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
      }

      /**********************************************************************
       * OAuth: auth code + PKCE
       **********************************************************************/
      async function startLogin() {
        setStatus("Starting OAuth login...", "muted");
        log("Starting OAuth login (Auth Code + PKCE)");

        const verifier = randomString(96);
        sessionStorage.setItem("pkce_verifier", verifier);

        const challenge = base64UrlEncode(await sha256(verifier));

        const authUrl =
          `${SF_BASE}/services/oauth2/authorize` +
          `?response_type=code` +
          `&client_id=${encodeURIComponent(CLIENT_ID)}` +
          `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
          `&scope=${encodeURIComponent(SCOPES)}` +
          `&code_challenge=${encodeURIComponent(challenge)}` +
          `&code_challenge_method=S256`;

        log("Redirecting to:", authUrl);
        window.location.href = authUrl;
      }

      async function exchangeCodeForToken(code) {
        log("Exchanging code for token...");
        const verifier = sessionStorage.getItem("pkce_verifier");
        if (!verifier)
          throw new Error("Missing PKCE verifier in sessionStorage. Click 'Login' again.");

        const body = new URLSearchParams({
          grant_type: "authorization_code",
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI,
          code,
          code_verifier: verifier,
        });

        const resp = await fetch(`${SF_BASE}/services/oauth2/token`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body,
        });

        const txt = await resp.text();
        if (!resp.ok) throw new Error("Token exchange failed: " + txt);

        const json = JSON.parse(txt);
        log("Token exchange OK. Received keys:", Object.keys(json));
        return json;
      }

      /**********************************************************************
       * Lightning Out 2.0: exchange OAuth token for frontdoor URL
       **********************************************************************/
      async function getFrontdoorUrl(accessToken, appId) {
        log("Requesting frontdoor URL via lightningoutsingleaccess...");

        // Some orgs use different param names; app_id is the first try.
        const params = new URLSearchParams({ app_id: appId });

        const resp = await fetch(`${SF_BASE}/services/oauth2/lightningoutsingleaccess`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Authorization: `Bearer ${accessToken}`,
          },
          body: params,
        });

        const txt = await resp.text();
        if (!resp.ok) throw new Error("frontdoor exchange failed: " + txt);

        const json = JSON.parse(txt);
        if (!json.frontdoor_uri) throw new Error("No frontdoor_uri in response: " + txt);

        log("Frontdoor URL OK.");
        return json.frontdoor_uri;
      }

      /**********************************************************************
       * Lightning Out / Flow events
       **********************************************************************/
      function wireEvents() {
        // LO 2.0 lifecycle events
        document.addEventListener("lo.application.ready", () => {
          log("EVENT: lo.application.ready");
          setStatus("Lightning Out application ready ✅", "ok");

          // Once LO is ready, set attributes on your LWC host so it can start the Flow.
          applyFlowInputsToHost();
        });

        document.addEventListener("lo.application.error", (e) => {
          log("EVENT: lo.application.error", e?.detail || e);
          setStatus("Lightning Out application error ❌ (see log)", "err");
        });

        document.addEventListener("lo.component.ready", (e) => {
          log("EVENT: lo.component.ready", e?.detail || e);
        });

        document.addEventListener("lo.component.error", (e) => {
          log("EVENT: lo.component.error", e?.detail || e);
          setStatus("Lightning Out component error ❌ (see log)", "err");
        });

        // Your LWC should dispatch this DOM event (CustomEvent) from inside handleStatusChange()
        // Example: this.dispatchEvent(new CustomEvent('flowstatechange', { detail: { interviewStatus }, bubbles:true, composed:true }))
        document.addEventListener("flowstatechange", (event) => {
          const interviewStatus = event?.detail?.interviewStatus;
          log("EVENT: flowstatechange ->", interviewStatus || "(no status)");
        });
      }

      function applyFlowInputsToHost() {
        const host = document.getElementById("posHost");
        if (!host) {
          log("WARN: pos-actions-host-lwc element not found yet.");
          return;
        }

        const { recordId, userType, userSfId } = getInputs();

        // These attribute names map to @api properties in your LWC:
        // flowApiName -> flow-api-name
        // recordId    -> record-id
        // userType    -> user-type
        // userSfId    -> user-sf-id
        host.setAttribute("flow-api-name", FLOW_API_NAME);
        host.setAttribute("title", " "); // keep same behavior as Aura host
        host.setAttribute("record-id", recordId);
        host.setAttribute("user-type", userType);
        host.setAttribute("user-sf-id", userSfId);

        log("Applied Flow inputs to <pos-actions-host-lwc>:", { FLOW_API_NAME, recordId, userType, userSfId });
      }

      /**********************************************************************
       * Main
       **********************************************************************/
      async function main() {
        wireEvents();

        document.getElementById("loginBtn").addEventListener("click", startLogin);

        document.getElementById("clearBtn").addEventListener("click", () => {
          sessionStorage.removeItem("pkce_verifier");
          logEl.textContent = "";
          setStatus("Cleared local state.", "muted");
          log("Cleared pkce_verifier + log.");
        });

        // If user changes inputs after LO is ready, let them re-apply without re-login
        ["recordId", "userType", "userSfId"].forEach((id) => {
          document.getElementById(id).addEventListener("change", () => {
            // Only apply if LO already bootstrapped (frontdoor-url set)
            const loApp = document.getElementById("loApp");
            if (loApp?.getAttribute("frontdoor-url")) applyFlowInputsToHost();
          });
        });

        setStatus("Ready. Click 'Login to Salesforce'.", "muted");

        const code = getQueryParam("code");
        if (!code) {
          log("No OAuth code in URL. Waiting for user to click Login.");
          return;
        }

        setStatus("OAuth code returned. Exchanging for token...", "muted");
        log("OAuth code found in URL.");

        // Exchange code for access token
        const token = await exchangeCodeForToken(code);

        // Clean the URL (remove code param)
        window.history.replaceState({}, document.title, REDIRECT_URI);

        setStatus("Getting frontdoor URL...", "muted");

        const loApp = document.getElementById("loApp");
        const appId = loApp.getAttribute("app-id");

        const frontdoor = await getFrontdoorUrl(token.access_token, appId);

        // Set frontdoor-url to bootstrap the LO2 session
        loApp.setAttribute("frontdoor-url", frontdoor);
        log("Set frontdoor-url:", frontdoor);

        setStatus("frontdoor-url set. Waiting for LO ready event...", "muted");
      }

      main().catch((e) => {
        log("FATAL:", e?.message || e, e);
        setStatus("Fatal error ❌ (see log)", "err");
      });
    </script>
  </body>
</html>
