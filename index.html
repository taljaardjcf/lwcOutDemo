<!DOCTYPE html>
<html>
<head>
  <title>Lightning Out 2.0 - Programmatic (Aura Site)</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #status { margin-bottom: 20px; padding: 10px; border-radius: 4px; background: #f5f5f5; }
    #status.success { background: #e8f5e9; color: #2e7d32; }
    #status.error { background: #ffebee; color: #c62828; }
  </style>

  <!-- ✅ Load from Salesforce Core domain to expose $Lightning -->
  <script
    src="https://warranty2amartfurniture--amartuat.sandbox.my.salesforce.com/lightning/lightning.out.latest.min.js"
    onload="window.LO2_READY = true;"
    async>
  </script>
</head>
<body>
  <h2>Lightning Out 2.0 - Aura Site (Programmatic 2)</h2>
  <div id="status">Initializing...</div>
  <div id="container"></div>

  <script>
    const APP_ID = '1Us9n00000000mPCAQ';
    const COMPONENT = 'c:posActionsHostLWC';
    const ENV = 'uat';
    const RAILWAY_PROXY = 'https://sc-auth-amart-production.up.railway.app';
    const statusEl = document.getElementById('status');
    const container = document.getElementById('container');

    function setStatus(msg, type = '') {
      console.log('[LO2]', msg);
      statusEl.textContent = msg;
      statusEl.className = type ? `status ${type}` : 'status';
    }

    async function bootstrapSession(frontdoorUrl) {
      return new Promise((resolve) => {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = frontdoorUrl;
        iframe.onload = () => {
          console.log('[LO2] Session iframe ready');
          document.body.removeChild(iframe);
          resolve();
        };
        document.body.appendChild(iframe);
      });
    }

    async function waitForLightningOut() {
      while (typeof $Lightning === 'undefined') {
        await new Promise(r => setTimeout(r, 50));
      }
    }

    async function init() {
      try {
        setStatus('Getting frontdoor URL...');
        const res = await fetch(`${RAILWAY_PROXY}/api/lo2/frontdoor`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ env: ENV, appId: APP_ID })
        });

        const data = await res.json();
        if (!res.ok || !data.frontdoorUrl) {
          throw new Error(data.error || 'No frontdoor URL received');
        }

        // ✅ Ensure frontdoor URL uses my.site.com (Experience Cloud)
        if (!data.frontdoorUrl.includes('my.site.com')) {
          throw new Error('Frontdoor URL must use Experience Cloud domain (my.site.com), not my.salesforce.com');
        }

        setStatus('Bootstrapping session...');
        await bootstrapSession(data.frontdoorUrl);

        setStatus('Waiting for Lightning Out runtime...');
        await waitForLightningOut();

        setStatus('Creating Lightning Out app...');
        $Lightning.use(APP_ID, () => {
          $Lightning.createComponent(
            COMPONENT,
            {},
            container,
            cmp => {
              console.log('[LO2] Component created', cmp);
              setStatus('Component loaded!', 'success');
            }
          );
        }, data.frontdoorUrl);

        setStatus('Waiting for LO2 to authenticate...');
      } catch (err) {
        console.error('[LO2] Error', err);
        setStatus(`Error: ${err.message}`, 'error');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
