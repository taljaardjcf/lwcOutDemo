<!DOCTYPE html>
<html>
<head>
  <title>Salesforce EC Embed Test</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; margin: 0; }
    #status { padding: 12px; margin-bottom: 20px; background: #f5f5f5; border-radius: 4px; }
    #status.error { background: #ffebee; color: #c62828; }
    #status.success { background: #e8f5e9; color: #2e7d32; }
    #ec-iframe { width: 100%; height: 80vh; border: 1px solid #ddd; border-radius: 4px; }
    .btn { padding: 10px 20px; background: #0176d3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
    .btn:hover { background: #014486; }
  </style>
</head>
<body>
  <h1>Salesforce Experience Cloud Embed</h1>
  <div id="status">Loading...</div>
  <iframe id="ec-iframe" allow="storage-access"></iframe>

  <script>
    (function() {
      const RAILWAY_PROXY = 'https://sc-auth-amart-production.up.railway.app';
      const ENV = 'uat';
      const APP_ID = '1Us9n00000000mPCAQ';
      const EC_SITE_BASE = 'https://warranty2amartfurniture--amartuat.sandbox.my.site.com';
      const EC_SITE_PATH = '/storeconnect';

      const statusEl = document.getElementById('status');
      const iframe = document.getElementById('ec-iframe');

      function setStatus(msg, type) {
        console.log(`[EC] ${msg}`);
        statusEl.textContent = msg;
        statusEl.className = type || '';
      }

      async function init() {
        setStatus('Getting frontdoor URL...');

        try {
          // Build the target URL with parameters
          const params = new URLSearchParams({
            flowApiName: 'StoreConnect_POS_Actions',
            recordId: '',
            userType: 'manager'
          });
          const targetPath = `${EC_SITE_PATH}?${params.toString()}`;

          // Get frontdoor URL from Railway
          const resp = await fetch(`${RAILWAY_PROXY}/api/lo2/frontdoor`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              env: ENV,
              appId: APP_ID,
              ecSiteBaseUrl: EC_SITE_BASE
            })
          });

          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || 'Failed to get frontdoor URL');

          console.log('[EC] Got frontdoor URL:', data.frontdoorUrl);

          // Modify startURL to go directly to EC site with params
          let frontdoorUrl = data.frontdoorUrl;
          if (frontdoorUrl.includes('startURL=')) {
            frontdoorUrl = frontdoorUrl.replace(/startURL=[^&]*/, `startURL=${encodeURIComponent(targetPath)}`);
          }

          console.log('[EC] Modified frontdoor URL:', frontdoorUrl);
          setStatus('Loading Experience Cloud (authenticating in iframe)...');

          // Load frontdoor URL directly in iframe - this authenticates in the iframe's context
          iframe.src = frontdoorUrl;

          iframe.onload = () => {
            console.log('[EC] Iframe loaded');
            setStatus('Experience Cloud site loaded!', 'success');
          };

          iframe.onerror = (e) => {
            console.error('[EC] Iframe error:', e);
            setStatus('Failed to load', 'error');
          };

        } catch (err) {
          console.error('[EC] Error:', err);
          setStatus('Error: ' + err.message, 'error');
        }
      }

      // Initialize on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
